"use server";

import { ID, Query } from "node-appwrite";
import { createAdminClient, createSessionClient } from "../appwrite";
import { appwriteConfig } from "../appwrite/config";
import { handleError, parseStringify } from "../utils";
import { cookies } from "next/headers";
import { redirect } from "next/navigation";

const getUserByEmail = async (email: string) => {
  const { databases } = await createAdminClient();

  const result = await databases.listDocuments(
    appwriteConfig.databaseId,
    appwriteConfig.usersCollectionId,
    [Query.equal("email", [email])]
  );

  return result.total > 0 ? result.documents[0] : null;
};

export const sendEmailOTP = async ({ email }: { email: string }) => {
  const { account } = await createAdminClient();

  try {
    const session = await account.createEmailToken(ID.unique(), email);

    return session.userId;
  } catch (error) {
    handleError(error, "Failed to send email OTP");
  }
};

export const createUser = async ({
  fullName,
  email,
}: {
  fullName: string;
  email: string;
}) => {
  const existingUser = await getUserByEmail(email);

  const accountId = await sendEmailOTP({ email });
  if (!accountId) throw new Error("Failed to send an OTP");

  if (!existingUser) {
    const { databases } = await createAdminClient();

    await databases.createDocument(
      appwriteConfig.databaseId,
      appwriteConfig.usersCollectionId,
      ID.unique(),
      {
        fullName,
        email,
        avatar:
          "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxIQEBAQEBIVEBAPDxAPDxAPDxAVEBAPFREXFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMtNyguLisBCgoKDg0OFxAQGi0dHR0tKy0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAMIBAwMBEQACEQEDEQH/xAAbAAACAwEBAQAAAAAAAAAAAAACAwQFBgEAB//EAEIQAAICAQEFBQQIAwcDBQEAAAECAAMRBAUSITFRBhNBYXEigZGxBxQyQlJyocEjgpIzYqKy0eHwFSTCQ1Nzk6MW/8QAGwEAAgMBAQEAAAAAAAAAAAAAAQIAAwQFBgf/xAA0EQACAgEDAgMGBAYDAQAAAAAAAQIRAwQSITFBE1FhBSIycYGhI5GxwQYUQtHh8TNS8BX/2gAMAwEAAhEDEQA/APlQnuy2ghIQ7CEIQhOiGiBCANBCEJ2EAQkDR3EhApA0dAhCdxAQl6HQPcTu7qqv2rLG3a1zyBbqfADJ/WUZ9Tjwq5sV8D7aqqgq2J3nBu9tqdwa2ycAAjgMY+0vMnynHy+05rL7nwiOXkMXZaON6rUKQeOLa7BgetYf9QJqh7Vg/ijRFk80e/6G3hdR/wDZYPmgln/0sHr+X+RvFXqLs2LcM7oW3HH+DbW7e5Ad8/CWw1uGbpS/MKyxZWkTUOcIkJQBEhACICAEQEBIgIDiAByADQJigBMBDmIAHIAHJCHIAHoCUOE0kOiEgQhCdhQQhCQICAgQhCdAhIEBIEICEh0CENBAQBHafTl88QqqMu7fZQefmfAePxmfU6nHp4bp/wCyEnaeoX6lQaWL1pbctwIAPeb3BiATj2d3HHlieO1WtefUSk1S4oacbx7kRNHqt7HHPQ59oe+BTM1FjTTniAPXip/TGffGsFFgiuB5fmU/MGNuIRNTbnhvbpB4eyp+QBHrxktPuSiPrM2glx/GVd/fBz31QBySfvEAE73PCsDxAnX9m6uSmsWTo+g2N067FcRO8aACIpASsABbLASgCJCA4gAcIgogGIoKOYgAzhEAAYoDhkIcMADkAB00hChIdEIQ4SHRIQISBoICEgQEIaCAhDR0CEIQEhA6wMrvEhcjeI5hc8SPPGYs7UW11JRpvpD0A0yLTp0auoe02CfafkWJJJM+fS1mTUZHLK7ZZkx1Hg+f6TXNXvqcsln21PXwYef/ADwgkk+SjHNxtdmCLMHKnHpCnQGidRte1eTRt7JtG2bZubm59Myb2TaI+tseZh3Eot9gav2k3uIqvocZ8Ue1a7a/RlI/p85qwSv6FOXg5qaNx3TOe7d0yfHdYjP6T2cXcU/M2R5SYkrCEAiAADCAgsiAgBEBADAAEwUA4YhDhgFBMAATAQ5AA9IAaJoCdEJAhCQIQhoICQNBrCEIQgoJYRggIQ0dAkJQYEgRulQGytTwDWIpJ8AWAleVtY5P0f6ENV9I+1HW56ioZMk5JHPyIOR6GfMsSvk2PhI+ejQvYN5FO74HwPp1mjfRT4Dauids/srqbj7Ce88BB4gvgmt2X9Fdz4Nt61joqFj8SYviB2JGgp+iDTEe1qb89QKgPhumTxGK68gLvocp3Tu6u0N90tVWVHqBgn4iOsjEpGR1/ZTUbN1NS3Yel7FsS2vO7YKnVt0g8VbiOB6nBOJ0NPJLqZskb6Ddo7PVle6kngS9qMSSATxcHpk8QfPpPUaXVrJUX9AYc0k1Cf0ZTEToGwEiCiUAwgILIigFsIAgEQAAIkFOYisgJigBIgACRABnIAHpADJeQIQhoLEYIQEhAxIEIQkCEIQhCNQQhIGBIEICElBo+6Qw4lSGHqDkfKLKO5OPnwSi77ZbKsv1uk3na1NbfUu8d0Kq2EMVXAzgIeZPhPmleG5x/wCtl+S9sfVo2G09l11lEVQFAwABwxMWJtvk3Sl7pabLpCgYE0mNl9QeUgjJ1RhRWxjQimd7f6QWaFnxltO6XD0B3X/wM034ZcJlUlyfNNiuDqtzmrAhl57y5AKn3Fh6ToYJtS4MmpdRvyZQvUVJU81JU+oODPXJ2k/M6adpPzAKyMgtlgJQsiKChbCAAsiAgLCAABEAACIrAcxAwAwAOERQHMQAGYmgiQUIwQhJQQhCGJCBAQhoICFBDAjECAkDQQhDQQEgQsSBo22zrBY+wui2Op/NXTeo/wAk+d+1cfh6vOvPn86Y8/hh8/2ZpNuf2onJxdTXJ+4Qz2i0lJxbqKkbxU2LvD1A4zUoSfYySyRXVmn0l4IBBzAFma1H0o6Kqx6yt7mt2rYpVXu7ytg43nB5g+EuWKRnlkRP2d9JWzriFNrUk/8Av1lV97jKj3kSPHJAUkzVanSjVaa6pSCL6XRWBBU76EKwPiOOZow8IryOmfDOx7ltdhgVZWKurfaRw43lYeBG6wM6WlV2/Iw62X4Yjaa/x78cu/ux6d409bh/44/JfodbH8Efkv0IhEsHFsIoBbLAwC2EUgthBQKAIikAMgACIGAGIA4RAKCYAHIADBLyBQhCAhCEIQhCQgYhCGIwQgIQhgQhCAhQQgJCUGBAE1PZnaelrXTfWbkpfTa7vKy7AZqeiwHIPMBi3Hq4njf4iwS8dTir3R5+gspxSpmd7e9orddqbF0xY6RDuq1YcLdgcXYgZ3c5wOWBmcXT4VBW+ombNPJxHojM6fZ29984xxFdLNgf88pe3LsiuONPq/sfV+zXbHSJSotvCFFC4K2FjgYzhVOZR4GR9jTLNjS4ZRbR2No9SbdXp9Le1VjvYbbdQKKXYsd41rxcjeyPs8+Aj3JcNlKjGXKjfzdIzus2ei2tT9XeixF37M23v3ScPbsG77I4jORwyMy6MfVv8ityj5JfmbLstt/aGymo0Yrr1FFrd+Dh7CtO+ot7tgy7uMhsbp4twzmPieOXQXPCa49DS6PQ6a/ad+qS5ltt3LbNOdNYNwisJv75AwG3c8eZzN0JrDB90zmyx5s1Q20Yrb+xr9LZ/HUA27zqyNvI/H2sHqCRkEA8R1nqNHqsWeH4b6cHex1tryKplmoehTLAAWVgYBbCKAUwgALYQEAMUAJEAACIGBgmKAExRTmICDBLwI6IRggISBgQhDUSBDAjECEIQxCEMCMEISBoICEIYgoha9o+zaVU6PUJlnD1JqCTlQzrvAAY5BioBngdf7RlqdTOPaNpfQbJp0oxyPrf2NLqdkq2tQ3KGoFtzFWGUNoI3N5fEAbxx1AnPwSp8jatN41tMAuytXVqbXtTh3gsa5s54BgVRs4IO95/ZXEtlNONdzHixSU010L3sZ2cXW2alsJwuYKLKldTwBPPlxJ4iCU5JJX2NEIY/eco3yzb9hag2z9IGXD6c91YhxkW6e4qR65UH4RZPbksrgnLFtRRbY+j36xrrNSt7LXdYzOgU75V2LOg44+8QDnocdW8ZLoJ/LvuaGjQr/1bS14ACaPVWlBx7tLL6VrU+XsuB+U9I2Hu/MmTsvJFlqtEU2pqGUFEfZ2nw+PZ3xbaCAeW9j5iatRJeBFd7f6IGkdSbZne3GmKaZQWZwNUjIXJLDeqs3lyfDgp906H8PNrNNen7o6OWUZOMkq4aMKwnrioUywAaFMIBaFMICCmEUAthAAUwikBMAADFYoJEVgYJigOQAGS8B0CEIYEIwQEJBgEgaCxHRAgIQhiEIwQhoICFBCAkGDxISj6DXs/69RVUWKJqNK3H8N3slGx1VirD8s+U6uLw6/JHyk/1N+WpaRrvx/77FfT2iuGa9TpHe0N/EfTmqyt3HN1BYMAeeCOGZaoxfMWYnLJHiUfyIm09rko2NJYOHPUNTWg9QGZvgseoruKpTfwx/Mufo10rUVZcHedi7HGMsxycDpxx7okpbmPHE1CmTdp7J1NGou1Ghfcq1Td7fQ9AsRdRjDWqoZWBYAE4J45yOWC5WqaKo4mm6lRHS3XvwOqrr6mnQHfHobbGAPqpkUoeQXiyf8AZF72c2VXpi9gd7r7mVr7733rbCv2V5AKoycKAAJdHJyJ4KSZoNrkGxVPjWp/xk/tGy8sTS/A36mF+kq4AUUjmWa4joANxT795/6Z6P2Bhac8nyX7miDv6GEZZ6QcS4kBQlhFAxTiAUUwgYBTRQCjAQ5uE8hFoAa6Nz4fOHYwUH9Qx9ogepAh8Mm08dInXPpk/rA4RI4kLKdG/SZXlguzKzwmkAQhGDEIQxCQIQoIwRghCEIwCEgSiEIYEIyQYEgwQkJRuOx+1V7musn+Jp9QjgE8WpZ/aYdcAkeWB1nhf4l0E4ahaiKuMqv0fT7mnBypQ80/7lHt9jVqLsndC2EE9Jw8S4Bll0ZBbbiV4ZWBI8SRw9My7Y2UrLFdyy2X26SvizqRz+0MxPDkuw/iwa6lsPpJDnCVkr4vw/wj98/GWrFNmaWXGunIOs7ZmwEUaYlgCeLbxA6lVH7xvArqxVm9DQ9nUvCA6jg5PEDkPKUx+I0SlwRO3m2LataBW2NzT1Ag8Rve037ieq0HsvFqMSyZLu+xm0fMJL1/Yxuu1T3WNbaxd2xknwAGAAPAAeE9FhwwwwUIKkjUoqKpERhLQ0KcSCsSwigANRPhACgfqvUgemT8oCbWMTQA/ib3BRJRNhKq2WT9mserFj/pBaQdhIGx7PEhfyqBB4i8w+GF/wBFXIDMT7Kk5Y8zxiKdqybES12fp06fpBvkMoryK/a1lQrcJz3Wx8IXJ07FnVGTVeExWZqOTaKkEJA0GIwaCEIQxCiBrHCg1kCMEYNBiEIQkGQYEIQwJA0EUyIPmSjT7e3bhXewBXV0qzjwFu7iwf1Az5lqMXganJi/6tjtXBX24MLZ2fUuVOVHNGU8COh54MaEmzFkxRXNF/2e7DK7fYF2Tj27ioHuCSzZMpU8C62b/RdhqUCtb3FQ4fa71/Dw3nUE+4wNNdWTxsbfuRbLpNgaZTWQC4qYOu8FSsupyrCpAq+yeIJGcge+mcl2LYqT5fHod2nra6FNlh3UTiepPgo8yeAgxQcppIsnKots+dbb1jX3G1xh3VWYeClhvbo8hvbvun0HQY9mCKBoY/hX5tkAibDYKcSEE2LwOOcDYrLG3YhSnfY5dnqrA6M9fen4Jue9pzoal5M21dFf9v1DtrgCjZX4mxNfiBUSWumpT7TZivI+waPNtGlOQzF5fVg4Il3aID7IAg4BuRW6vb7t449INyQjyFfdtRiQc81H6cJXHN1XqK8gJ1jNyyfTMfe30BvYm52wd7gMEceHhA2+4kpcckOuwYHHwmeMlRWpRo6ozN5By6d/wN/SY21jbWMXR2fgPwh2sbaxi6Gz8OPUiHaw7GNXQv5D1YRlEOxjF0LdV+MbaHw2MXQ/3h7gYaGWMauh/vf4ZKG8MYuhHU/CQOwYujHQwh2IMaUfh+JkG2oNaR+ESB2jFrHQfCAm0bqNWVoIIytT+0BzUNxWwfBgR0A6Txf8QaXZqVlXSa+6/wAAuotFdVqA3tIQfT95xKKdy7FpR2k7kDvKwRnGfaBz7oy3PoLJwXMkjT9n9uLapetUrUeyzBcEeOCTBKMr5BujXBO1/a7T0Kfb76z8FRzx825CFYpMqlkSMDr9sW6/UJ3hxWrbwrXO4ijm3mcZ4/KdXQae5pIx5skpcLq+g+xt5i34iT6eU9pCO2Kiux2cWNY4KC7AERhhTiEBGubd4+GRn0iZPhEfBYbV24Hqxnj3td3/AOAqYe4oD75xMEJY83pTX3ssm0laKSzapPjOhZT4pEs1xPj+sDbEeQSbifH4Bj8oBHIA+ljflrI+cHHq/oLu9GLYkcqGPm74/QQO+2Nv5sVyfaIvN2fZRE/pJHxiVn/pikK3l7I49Opbm/wJ/YRZY9VL+qhXHM+5X6vSumC5zn837zHnwzxq5Sv8yqeOUerI8zJldGg2f/aJ6z0kXydDH8RoKkDZJc8+svs1KvM89afiJ9WMm4nAFYT2s/hOOPjElKqJwCrpLNyAmhgvToJNwdyCGrXpJYdyC+ujpITcj312Em499bMgdxz6yYQ2e74yEs73xkDYVVuCc8VdSjjqp6eY4H3TF7Q0a1WBw79U/UVma2jpjTaQDgc1ZSRlfAzwsoShJwmqa6mDLHax9du9jeJbHEZJMdJIocn3JdbqIwLFX6vko5ngMc+MeKtitlrsvTlAWbgz8x0HSep9naN4Y7p9TbptK1LxJ9V0RPxOmbzxEgBbCQAixQQc8RgwPoJJBrsVcZZkH8ufnKbXkDwzx2bUOdgHoq/6SbvQmxAHT6cc7GPpgftJuJtXmAzaUeLH+Ywbwe6IfWaYHhXn1MHiIW4IXZtWofZpUe6K8qQN8fIQduY+yqj+URXnQPFItu23P3sekR6gR5vUq9dqu8xk5wZk1GZZEk2UZJqXcjbomdRoSkWVBwwPnOyzREkiw8eMVSY1hd75w7mEKu0cfSB8jJnlsEtTIGrxuQhqT0MZJhGBW6GNTG5DFbdI1Bphd20IaZ7BhIewZBjokCOoEhCy0OwV1joliv3RLhrUGNwhC3BiMZ4DhOF7bjgWCWSVb0uPP/RRkjGXD6mb21sA6WwqlpdeON9BnHmQcH4CePx6jcuhTk0m3oyPptBZYd3e5/hEt8UrWnfmfRexXZTcFrqu9edPetZJGQ7VMo4n7OSecv0uT8WLl0TVgmoYqsqtTpmqdq7FKPW266nmDPdwyRyRU4u0zpxkpJNdGAI41HSIAC2EICHrUJRgOeDj1gkrQk+hRvtI+JOfEecwSyUZ3kZHfaB85W8oryCm1jHwivJJi72La1z4RLm+wLkcFVphWPKwVNjV2ba3X9Yy0831YfCkxqbCsIJOeGP1h/luabCtOx9fZlz4Rv5OPcb+VJC9lD/wRlpcaG/lYke3Z4QlenCW+FEV44p0QxGFROo0oZN7xi0XRhasfVXUB7QJPjxlsdlBqK6hg1DlX8THuIbj5BC5ByQQ7kG15BjVDwUCHcTce+tHyEO4O4535PjJuJZ7vT1hTJZ7fhsISox5An3SWHkeujc/d+MlpBocmzm8So/mgeRBJuzNj2WWJWAR3jY3iMALzZxnmAMnh0mXUa7Dhg5OS47FU8sY9za7ZproRGVu5XTqVrY8VAZSuGH3ic5yOOT48p4SeXNqpST5cnZjjNQmpvlnz6pfr+qFS2IGb7LHfCufwrlQd7yOJavZWfHG5KkaM+pSjupn0bYPYqunBsJdhjyX/X9YY6eK68nJy67JLiPBs9JStYCqAoHgBiW0jG227fJiPpE2Qx1Fd9Sl+9rxYEGWDV4AbA4nKkD+Sd32TqYrHLHJ1T4+v/vudnQaqEYbJuvIxY/2PrO2nZ1rPESWQW0KFEWnAJhFYeyuzSWr3tnIuxb8qVmxz/lHvM4+ry1Pauv93SFjjilbKurYoPE4GeM2KEQeErJVexqxzMakHwoklNDQvSQbbFDQ1C+Akth4OnaNQ5AQWC0Ifay7p4D7S/Ixb99AckdTbIHgIzoG5HLNs55SWg7kZjXanNjnPM/tElOmZZv3mRhLQE7SavdG6RwgaLIypUDZaCSRJQG+TysYyIHCE6BCEYqxhgwsJKGKojIZIelmOWPgIbGHVWO5CrvMx5KgJY+gHGJKairk6JuonNs16wH1ROnq4bzOR3mOgrznPrgCc/P7Tw409j3PyX9yuWaK9Q9TtOqhc6esDhlbbMPawI4MDyXh+ECcTJq8+f45UvJcIyzyyfVll9GhayzVamwl7Du0qzHJVT7TAHz9j4TFrbSjjXzM0Zctso/pD241+oFS8aKmKLjPt3fef3cQPf1mnQQUJK+rBhyJzbf0KrSVO+6tALXt7VO59reHENny558MT0eWUY4ZX0aNOSUVB2fcuy21frekpvI3XIKXJjG5eh3bFx03gceRE8sziNUL7W9qK9n07xw91mRRTn7RHNm6IMjJ8wOZluHC8jpdAwjuPkh7R3Na19thZ2OSfkoA5AeAE7MMcYx2roPLEmiy/wD6yq0YvoNxxgOMJZ/XkH45EaMZQ+B7f0/IfFPPhfuS48n0Ji7OWzjRajA8QljbjjyyfZPrkek0x1VfHH6rn/J08XtXG+MicX9iHq9FZXxdGUfixlP6hwPxmjHmxz+Fm/Hnx5PgkmV2qHstjoZc+g0+g7Q7W3agmeB71T+W2rd+YHxnE1ON+JuXp9mNBprkpRtA45zcpFO+hb649fnJuYryCW1Z8/1gti72La9j1g94G5gs7dJPeBuYBsYA58ceIiSUrTJuOLafL+oRuQbjvf8AmP6hDyTcR7SCSeEVtFb5YQmgcNYwwayDUMVoUQaDCEIGQIYzGGChQSToNFZfYtVY3nb3AAc2Y+CjrK8uaOKLnJ8IEpKKtmkOh0ukH8T/ALq7x3sikN0VBz/mz6CcWevzZvg92P3Mk88n04Jeq26ta7lIWpeRFSKgPmQoE5Xv5Hc22K2+5m9obSL8/aJ68QJbGCEbKfUWljxOSZpxwtlUmbvsZQ1dDqMjvFrtDYOMOvgeox8pk1UVLM35GV5OGjM9rKlSxQB4gY/cef8ArNXs9XmT8jTpY9ZGs+jfQoBffjNjOKw3RN0McdMnn+UTV7UdSjFdKv6ia3ql2NPfqq9nDUao8KrALLEXdGdQAFVl83G6p81XqZylFydIxVfB8f2ttW3V3PqLjl35AfZRB9mtf7oz8zzJnWxY1CNI0qNIjLL0ENYwCVpb2yADj5DziykorkVxTL/SdoDSMKSTjBY8z5Y8BK2vE6lbxJO0S69rUX+zdUvH79YCWeuRz94Mtgpw+CVfdDx1GfFzF2vJlVtHsuUbeVw1VhJrfJU48VYeDDI/QzRjyRycSVNdTraTPHURtcNdUQjsED7y/FpbUTV4SAOx0HN1/X/WGo+QPCR47MpHOxf6ZKQfDQptHSPvj+gScE2R8zgpoHNifRVH7QWgVEHfoHgx94ktA9wF9TSOSH3sZN6JcfITZq68cKx8TFc0DdHyIJZfwiJa8isUI5EGIyGCEIQ1jBHrIMhiiEI0CEIXCEJrgBs/SgHhqNQoe0+KLzWryxzPmT0E8zq871Oao/DH7+pjyzsxer1jMS5PI5mjYoQfyMTlyc+uEjOZiiuC2xPfcF/KvylmNcCNi1bmegM14VyVyPr64qoXPAV1qPQKv+05c3bZk6s+V7W1nf3lhyU4x0PifkPdOxoMO2G7uzsQjsio+X6m7+ja/H1lDy/hOPU74PyWJ7Vj8EvmZNavhZS/SFt3v7xp0P8AC059rHJrsfsDj1J6TLpcf9TM0ImXBm9FgawgCLYGTyHOG65Iert4dM/KZFLxJX2GodXNkVQrJNLYIlqK5dDSWsX2fqOtQrvXqCHCt/hZok3tyQku/AmhyeHqku0jGNrPOaNx6NyFNqvOC2LbAOpgsFgHUQWCwDcZOQWc3zDTJZw5k2sALBukVxYHZHNhmdydiORIE2liDEKYwQjjDFkINUxhhgMgQgY1BLrsrohdqU3hmukG+zPIqmN1fexUemZh9o5/BwSa6vhfX/AmR8EftRtI3XNxzxnG0mOonOzS7IoNe2Kn9JszcY5fIzEOi3hOfj6FiY2qzKr6Y+HCX4/hBZI0oycdeHxmnHxYsmfQvpA2j3WnFan2rm3R6cz8v1nPww3zoTTRuafkfONJzz4zvYlR0zU7H2yNLXqLF+21IVFPLf3xg+nE/CZvaK3RgvUzatWomZVjxJOSSSSeZJ4kmVQVIzjEMsTIOWEBFvs3mCDkPab0HIfGZtRk6RXcKQ+s5MfDGkFkysTUhGPq5yyIkjQsdzQarq9aVL5lrFz/AIQx90GSO6cF63+SKdHHfq412tmM+q+U07T0+0IaPP3ZNhNg1dAfwCTag7GNXQH8C/CGieGxg0D/AIV+EgfDZ46B+ij+USE8NnRs9+vwAkonhkbaWnNdZJby8IsuEV5IbUUJWYtpmokCay1BiMhkGIyCEIQjVjDDBCQMCEJqtkD6vs+248G1L7q//FXkf5i/wE877VyeJnjiXSP6soyy+xjy28xPUy/GqRy5O2RNsN/CPqPnF1LrGxSs07zBjDZI0rcCOjH9eP7zRj6NEJ+hbDj1HzmiHcEuhdfSNq9/VrX4VJ7ssf8AaUaKPLZZplw2Uem4+vz/AN52Ico2IC63ebyXgPXxMxZ57p15GXPK3R4NETKRyGMgHrbcD14AdSeQEkpKKtkLbYfZDUW+1aV0wc5HfZ7zd8P4Y4j+bE4mTWwU2+ppx6aclfQiPpzXZZWSCa7HrJXkSrFSR5cJ28MlKKku6KJKnRISXorZK0aZYS6KKckqLXbtoWumn1uf9VT/AM/iI+JXNy8uP7m32Li+PM+/C/cpgwEvO7aDF4EFh3BjWARbJuQX/UYNxN5w7Tg3A3i32nJuB4gptpGDeDxCBtPVF194iylaKskrRVyopolVaZj4Y9ZoUGOojzoz4GNtGoWaWHhJQaPAQhGCFEDUxgjqa2dlRRlnYIo6sxwB8TBKSim30RG6NH20vWtatKhytFa18PEgYLe85PvnlcDebLLK+7MGaf3MognVRiZB21/Zn1HzlGr/AOJkKilpz4PkhJpbD/mH6iaIP3vmEn6dva9x+U0Q6gl0G7c1Xeau9+YL49wA/wB42kVRL9OqiJZt1c+XD1m2c9kGzRJ0rFJynOTMD5DUxrIPqBZgqjLMcAdTJLIscXKXRBjFydI+n9n9gppqlO6WuIy9iIA2T91XYZC+mPfznm9Tq55pPsvI6mPDGC9SaKd05GlLeZIsb3AsT8BMhffqZntGNGKyK6e51O8rAYsUlSfaLIxxjGeOOc7nszUZp5NjdxS/0YNTjhGNrqZ9Z6BHPZc7E0+8w6kjEu6KzFqJcEDa+p7y+1h9ne3U/Ivsr+gB98uxx2wVnptHh8LBCPp+pBZjCaRbOYrAxZsMRgBNhgACXPSAADOekArsAuehg5ByA5YjGD8IOQOwe7b8MNPyBTLzdmwvo8RICjm7IGgTWJKJQBoElEo53MlELzspp92x9S/2NKm+PO5sise72m/lE5ntXNtxeGus+Pp3KssqRRbR1RtsZz4kmY8GPZFI5mSVsSOU0lRW7ab+GfUTNq3+EyFVXW/4W/oacyM0u5CfTs7UPumui5zkY3KLWz4YGBLXliu4aZr9T2Iu01K36q2qhnI3NOC1lzHmQd0box48SPPPCX49RcqirJ1Kx9j1klhawJJJ3qwRx9CJoxzcOKLYT2qhVuxn5LZWwzniWB+GMfrGyZnJVQZ5Nyojvsq4clB8xZX+7ZlVlNHhs64f+mfcVPyMKkiUaPsrs0I/eXEIehwSo6AdT/zoeVrp5Mr2Ri6X3N2mjCK3Nq2bJtdT46hx/NWP/Gctwa6qjUmmNuZq6bL6rw4rrewpbj2gqk4DLjHLoZErdIjlXUxO2+0Ta7uspuCrfxnmd7dz6D2RPSezNNPDGTnw32ObqcsZtbSEs60TIzQbObuqns8VQ7v5zwX9SPhL3HdUfMzYcfjaiEPX7Iowk0M9hQaoOMrkyJIKupTzi2FJDxp64tjUjp0lflJZNqFPoa5BdkSNZoFkFcEIOgHWQTw0eOh/vGSgeGVVuoIYgHgDiVObTM8p06Lw59Zts0gd51GILBZ1SDyhTIFiEJ3dhJRxsDieEBGWm3bPq+mq0o4O/wDGv677gYU+i7o9QZ5vLk/mNRKfZcI5+ond0ZdRNUUYWFY2B16DxJ8BGlJRTk+iBVm47JaDulDYAduLN4+mek8nrNVPLJtvjsdbDhUI+psV1m6OLY95mDcy7agqtpLul85HEA56cz+3uM36TF/Wzn63LXuL6nyXtTt9tVqXfPsITXUOig8T7zx+E7+nilH5mNFUNSZooNh/WTJRLO/Wj1kolnfrZ6w7SWENUesO0g1NU3X3eEOxPqiX5De+ypXiAeYViFPqBwMrjo8KluUeRvFnVWCiYmuioOsZYDzlkFyJN1EvNS2KkT8R3z6DIUf5vgJshH3rNfsXDcp5n8l+5VspEsaO6LZyMyqUQNiu+xFaFs4dT5xCbgTqj1gJuBOqPWCwbwW1R6wWByB+snrJYNx5tUcHj4SbibypMpZlaLOrVecvU2XKTHi/POOpj7zxweUayHk3vCDfQUH35HOMpksm9ndP3+pTf411g32jwKJg7p8i26v80ya7P4WGT7vhfUSbpEraela+17HYAsxPGcPBNQjRz5q2Vt+y2XipVh5OM/AzbHNF9eChxA2boib17xWVK/aO8pALeAHXxPwmP2jm/D2w5su08E52+xq7dtLWu6mOE888b7nT3IoNXt12J9r9YdiQN5Kq21/2u5njhgfexP7zo4X7iONqE3lbMELvHrxnTjOkhRi2yxTIGLY28gQshUiHRZGUiBiyNuINrsjJkJdTy1MUcXjkH7NXeeXYlbM+Zvou5aXvvEnw5D0HATdFUj1OlwLBhjj8uvzIlrxi1siWMZWxGRbIjAJaVsUWcxWgM5umKKe7sxWA4UMUAJUwAFd2YotBiWEJNXKEYasZDIlabkYs+pZEVdzlkegGaHsf/Z6w+O7QM+OCz5H6D4Tke2Phx/NlGbsVu03O8eJ+MyYDHPqV4Y9ZqSKmGrHqfjJRBjOSDkk+piOKa5QE2ZjabEPwOPThOdqYRXRDKTvqWWx3JrOST7XifISiHQTI7ZS+Hum/sIGIz6EDEZADEsIEIyIEsKINSWRCTKZdEA5+UcBZbF5N+Uzbpw6ZXq8dky2az1DItkggh4jFYlojFYl4jACIoA4jFAMUABgYATFYoEAT/9k=",
        accountId,
      }
    );
  }

  return parseStringify({ accountId });
};

export const verifySecret = async (accountId: string, password: string) => {
  try {
    const { account } = await createAdminClient();

    const session = await account.createSession(accountId, password);

    (await cookies()).set("skystore-session", session.secret, {
      path: "/",
      httpOnly: true,
      sameSite: "strict",
      secure: true,
    });

    return parseStringify({sessionId: session.$id});
  } catch (error) {
    console.log("Failed verifying user ",error);
  }
};

export const getCurrentUser = async() => {
  const { databases, account } = await createSessionClient();

  const result = await account.get();

  const user = await databases.listDocuments(
    appwriteConfig.databaseId,
    appwriteConfig.usersCollectionId,
    [Query.equal("accountId", [result.$id])]
  )

  if(user.total <= 0) return null;

  return parseStringify(user.documents[0]);
}

export const signInUser = async (email: string) => {
  const existingUser = await getUserByEmail(email);

  if(existingUser){
    await sendEmailOTP({email});
    return parseStringify({accountId: existingUser.accountId})
  }

  return parseStringify({accontId: null, error: "User not found"});
}

export const signOutUser = async () => {
  const {account} = await createSessionClient();

  try {
    await account.deleteSession('current');
    (await cookies()).delete("skystore-session");
  } catch (error) {
    handleError(error, "Failed to sign out user!")
  } finally {
    redirect("/sign-in");
  }

}
